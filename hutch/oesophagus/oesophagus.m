function oesophagus

% control
ts3(1) = 22/7;
data3{1} = sparse([
	 0  0 39 14  7  4  1  0;
	 0 59 24  6  3  0  0  0;
	32 33 17 15  1  1  0  0;
	 5 11 10  2  3  1  0  0;
	 4  6  3  1  1  0  1  0;
	 5  1  1  2  1  0  1  0;
	 1  4  3  2  0  1  0  1;
	 0  1  0  0  0  0  1  0;
	 0  0  0  0  1  0  0  0;
	 0  0  1  0  1  0  0  0;
	 0  0  0  1  0  0  0  0;
	 0  0  0  0  1  0  0  0
	]);

ts3(2) = 30/7;
data3{2} = sparse([
	 0  0 26  9  3  2  1  0  0  0;
	 0 35 32  8  9  1  1  0  0  0;
	12 26 23 12  8  2  2  1  0  0;
	 3  8  6 10  7  2  0  0  1  0;
	 3  5  9  6  7  3  0  0  0  1;
	 1  0  2  9  6  2  1  0  0  0;
	 0  2  1  1  0  2  1  0  0  0;
	 0  1  0  1  1  2  1  3  1  0;
	 0  0  1  1  1  2  1  1  0  1;
	 0  0  0  0  2  1  0  1  0  0
	]);
data3{2}(16, 7) = 1;
data3{2}(17,10) = 1;

% pre-treat/atra homoestasis
ts3(3) = 3;
data3{3} = sparse([
	0	31	23	21	10	7	1	0	0	1	0	0	0;
	9	21	24	10	10	5	3	0	1	0	0	0	0;
	8	25	16	14	4	1	2	1	1	0	0	0	0;
	4	2	14	5	5	6	0	2	1	0	0	1	0;
	3	2	7	7	4	2	3	3	1	0	0	0	0;
	0	2	2	1	1	3	0	0	1	0	0	0	0;
	0	1	1	2	1	2	2	1	0	1	0	0	0;
	1	0	0	1	0	5	0	0	0	1	0	0	0;
	0	0	0	0	0	1	3	0	0	0	0	1	0;
	0	0	0	0	1	0	2	0	0	0	0	0	0;
	0	0	0	0	0	1	1	0	0	0	0	1	0;
	0	0	0	0	0	0	0	0	0	0	0	1	0;
	0	0	0	0	0	0	1	0	0	0	1	0	0]);
data3{3}(15+1,12+1) = 1;
data3{3}(17+1, 7+1) = 1;
data3{3}(19+1,10+1) = 1;
data3{3}(19+1,20+1) = 1;

ts3(4) = 6;
data3{4} = sparse([
	0	7	12	2	4	2	0	1	0	0	0	0	0	0	0	0;
	3	15	10	7	9	1	0	0	0	0	0	0	0	0	0	0;
	4	26	12	9	4	1	1	0	1	0	0	0	0	0	0	0;
	4	4	17	10	7	2	2	1	0	0	0	0	1	0	0	0;
	1	5	5	8	6	5	3	0	1	0	0	0	1	0	0	0;
	0	1	3	4	2	6	5	1	1	0	1	0	0	0	0	0;
	0	0	2	1	2	3	2	3	0	1	0	1	0	0	0	0;
	0	0	1	3	3	1	0	0	2	0	1	0	0	0	0	0;
	0	0	0	1	0	0	2	0	1	0	0	1	0	0	0	0;
	0	0	0	0	0	0	5	1	0	1	0	0	1	0	0	0;
	0	0	0	0	2	0	0	1	0	3	0	0	1	1	0	0;
	0	0	0	0	0	0	3	1	1	0	0	0	0	0	0	0;
	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0;
	0	0	0	0	1	0	0	0	0	0	0	0	0	0	0	0;
	0	0	0	0	0	0	0	0	0	0	0	0	1	0	1	0;
	0	0	0	0	0	0	1	0	1	0	0	0	0	0	0	0]);
data3{4}(20+1,20+1) = 1;
data3{4}(21+1,13+1) = 1;
data3{4}(25+1,21+1) = 1;
data3{4}(46+1,40+1) = 1;
data3{4}(51+1,26+1) = 1;

% atra treatement, 3 weeks after induction
ts3(5) = 22/7;
data3{5} = sparse([
	0	23	29	17	8	2	2	0	0	0	0;
	14	48	23	7	2	2	0	2	0	0	0;
	15	32	23	15	6	3	0	0	0	0	0;
	8	11	22	15	3	1	1	0	0	0	0;
	0	6	15	10	5	5	0	0	0	0	0;
	1	4	5	3	1	1	0	0	0	0	0;
	0	1	1	3	7	1	0	0	0	0	0;
	0	0	0	0	3	3	0	0	0	0	0;
	0	0	0	4	1	1	0	0	0	0	0;
	0	0	0	0	1	0	0	0	0	0	0;
	0	0	0	0	2	2	0	0	0	1	0;
	0	0	0	1	0	0	0	0	0	0	0;
	0	0	0	0	2	0	0	0	0	0	0;
	0	0	0	0	0	0	0	0	0	0	0;
	0	0	0	0	0	0	0	0	0	0	0;
	0	0	0	0	0	0	1	0	0	0	1;
	0	0	0	0	0	0	1	0	2	0	0;
	0	0	0	0	0	0	0	0	0	0	0;
	0	0	0	0	0	1	0	0	0	0	0]);

ts3(6) = 30/7;
data3{6} = sparse([
	0	22	29	21	11	11	6	1	0	0	0	0	1	0	0	0	0	0	0	0;
	5	24	14	19	11	3	5	1	0	1	0	0	0	0	0	0	0	0	0	0;
	2	19	19	18	10	4	3	1	0	0	0	0	0	0	0	0	0	0	0	0;
	2	3	6	9	8	5	3	0	1	0	0	0	0	0	0	0	0	0	0	0;
	0	1	9	8	4	6	4	2	1	2	0	0	0	0	0	0	0	0	0	1;
	0	0	2	7	2	4	1	2	2	1	0	0	0	0	0	0	0	0	0	0;
	0	0	0	2	3	2	1	0	1	1	0	1	0	0	0	0	0	0	0	0;
	0	0	2	3	1	1	0	1	0	0	1	0	0	0	0	0	0	0	0	0;
	0	0	1	2	2	0	0	2	1	0	0	0	0	0	0	0	0	0	0	0;
	0	0	0	1	0	1	0	0	1	1	0	0	0	0	0	0	0	0	0	0;
	0	0	0	0	1	0	0	0	0	0	0	0	0	0	0	0	0	0	0	1;
	0	0	0	0	0	1	0	1	0	0	0	1	0	0	0	0	0	0	0	0;
	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0;
	0	0	0	0	0	0	0	1	0	0	1	0	0	0	0	0	0	0	0	0;
	0	0	0	0	0	0	0	0	1	0	0	0	0	0	0	0	1	0	0	0;
	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0;
	0	0	0	0	0	0	0	0	0	0	0	1	0	0	0	0	0	0	0	0;
	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0;
	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0;
	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	1	0	0;
	0	0	0	0	0	0	0	0	0	0	0	0	0	1	0	0	0	0	0	0;
	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0;
	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0;
	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0;
	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0;
	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0;
	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0;
	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0;
	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	1;
	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0;
	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0;
	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0;
	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0;
	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0;
	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	1;
	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0;
	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0;
	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0;
	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	1	0	0	0;
	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0;
	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0;
	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0;
	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0;
	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	0	1	0	0]);

% optimal estimates
rho = 0.48;
r = 0.22;
lambda1 = 7/8.8;
lambda2 = 7/5.1;

bubble_compare(lambda1*ts3(1), data3{1}, r, rho/(1-rho), ...
    'oes-comparison-control-22-days');
bubble_compare(lambda1*ts3(2), data3{2}, r, rho/(1-rho), ...
    'oes-comparison-control-30-days');

bubble_compare(lambda1*3 + lambda2*(ts3(5)-3), ...
    data3{5}, r, rho/(1-rho), ...
    'oes-comparison-atra-post-treat-22-days');
bubble_compare(lambda1*3 + lambda2*(ts3(6)-3), ...
    data3{6}, r, rho/(1-rho), ...    
    'oes-comparison-atra-post-treat-30-days');

!rubber --pdf oesophagus-fit.tex

% make the legend

colours = [
 0.996078, 0.360784, 0.027451;
% 0.996078, 0.988235, 0.0352941;
 0.541176, 0.713725, 0.027451;
 0.145098, 0.435294, 0.384314;
 0.00784314, 0.509804, 0.929412;
 0.152941, 0.113725, 0.490196;
 0.470588, 0.262745, 0.584314;
 0.890196, 0.0117647, 0.490196;
 0.905882, 0.027451, 0.129412
];

kk = 6;
fh = figure;
ah = newplot(fh);
set(ah, 'NextPlot', 'add');
set(ah, 'FontName', 'Helvetica', 'FontSize', 9);
set(ah, 'DataAspectRatio', [1 1 1]);
set(ah, 'XLim', [-0.5 2.0], 'YLim', [-0.5 kk+0.5]);
set(ah, 'Visible', 'off');

labels = {'1%', '5%', '10%'};
r = sqrt([1 5 10] / 100);
y = 2 + cumsum(2*r) + [0 0.2 0.4];
for i = 1:numel(r)
    rectangle('Position', [0-r(i) y(i)-r(i) 2*r(i) 2*r(i)], 'Curvature', [1 1], ...
        'FaceColor', colours(1,:) * 0.50 + [1 1 1] * 0.50, 'EdgeColor', 'none');
    rectangle('Position', [1-r(i) y(i)-r(i) 2*r(i) 2*r(i)], 'Curvature', [1 1], ...
        'FaceColor', 'none', 'EdgeColor', 'k', 'LineWidth', 1);
    text(1.1+r(i), y(i), labels{i}, ...
        'FontName', 'Helvetica', 'FontSize', 8, 'Color', 'k');
end

text(0, 1.8-sqrt(0.01), 'theory', 'Rotation', 90, 'HorizontalAlignment', 'Right', ...
    'FontName', 'Helvetica', 'FontSize', 8, 'FontWeight', 'bold', 'Color', colours(1,:));
text(1, 1.8-sqrt(0.01), 'experiment', 'Rotation', 90, 'HorizontalAlignment', 'Right', ...
    'FontName', 'Helvetica', 'FontSize', 8, 'FontWeight', 'bold', 'Color', 'k');

set(fh, 'PaperUnits', 'inches');
w = 1; h = 4;
set(fh, 'PaperSize', [w h]);
set(fh, 'PaperPosition', [0 0 w h]);

print(fh, '-dpdf', '-painters', 'oes-comparison-legend');

close(fh);

end
